# LEOPARTS Visual Flowchart

## Complete System Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              LEOPARTS APPLICATION START                            │
│                              app.py:main()                                        │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              USER NAVIGATION                                      │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Chatbot       │    │   Extraction     │    │   Debug         │              │
│  │   Interface     │    │   Interface      │    │   Interface     │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              DOCUMENT PROCESSING PIPELINE                          │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              FILE UPLOAD & PROCESSING                             │
│                                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   PDF Upload    │───▶│   Text Extract  │───▶│   Image Extract │              │
│  │   (PyMuPDF)     │    │   (PyMuPDF)     │    │   (Mistral)     │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Chunking      │───▶│   Tagging       │───▶│   Vector Store  │              │
│  │   (Recursive)   │    │   (Dictionary)  │    │   (Chroma)      │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              THREE-STAGE EXTRACTION PROCESS                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              STAGE 1: WEB EXTRACTION                              │
│                                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Part Number   │───▶│   Web Scraping  │───▶│   HTML Extract  │              │
│  │   Input         │    │   (Playwright)  │    │   (BeautifulSoup)│              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Web Chain     │───▶│   LLM Process   │───▶│   JSON Parse    │              │
│  │   (Groq)        │    │   (Groq API)    │    │   (extract_json)│              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Success?      │───▶│   Store Results │───▶│   Queue Failed  │              │
│  │   Check         │    │   (Web)         │    │   for Stage 2   │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              STAGE 2: NUMIND EXTRACTION                          │
│                                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Failed Attrs  │───▶│   NuMind Chain  │───▶│   Schema Config │              │
│  │   from Stage 1  │    │   Available?    │    │   (Custom)      │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   File Data     │───▶│   NuMind API    │───▶│   Structured    │              │
│  │   (Bytes)       │    │   Call          │    │   Results       │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Extract Attrs │───▶│   Update Results│───▶│   Queue Failed  │              │
│  │   (Specific)    │    │   (NuMind)      │    │   for Stage 3   │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              STAGE 3: PDF FALLBACK                                │
│                                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Failed Attrs  │───▶│   Enhanced      │───▶│   Create 20+    │              │
│  │   from Stage 2  │    │   Search Queries│    │   Search Queries│              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Query Vector  │───▶│   LLM Process   │───▶│   Rollback      │              │
│  │   Store (20x)   │    │   (Enhanced)    │    │   Logic         │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Final Results │───▶│   Preserve      │───▶│   Update        │              │
│  │   Validation    │    │   Original      │    │   Final State   │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              MANUAL RECHECK SYSTEM                                │
│                                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   User Selects  │───▶│   Enhanced      │───▶│   More Chunks   │              │
│  │   Attributes    │    │   Prompts       │    │   (k=15)        │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Manual Chain  │───▶│   Process       │───▶│   Update with   │              │
│  │   (PDF)         │    │   Results       │    │   Rollback      │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              RESULT DISPLAY & EVALUATION                          │
│                                                                                   │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Card UI       │───▶│   Source        │───▶│   Success       │              │
│  │   Display       │    │   Indicators    │    │   Status        │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │
│  │   Metrics       │───▶│   Export        │───▶│   Debug         │              │
│  │   Calculation   │    │   Functionality │    │   Logging       │              │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Detailed Component Flow

### PDF Processing Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Upload PDF    │───▶│   Save to Temp  │───▶│   Extract Text  │
│   Files         │    │   Directory     │    │   (PyMuPDF)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Extract       │◀───│   Process       │◀───│   Extract       │
│   Images        │    │   Images        │    │   Images        │
│   (Mistral)     │    │   (PIL)         │    │   (PyMuPDF)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Create        │───▶│   Tag with      │───▶│   Add to        │
│   Chunks        │    │   Dictionary    │    │   Vector Store  │
│   (Recursive)   │    │   (Attributes)  │    │   (Chroma)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Web Scraping Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Part Number   │───▶│   AsyncWeb      │───▶│   Browser       │
│   Input         │    │   Crawler       │    │   Config        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Crawl         │───▶│   Extract       │───▶│   Clean HTML    │
│   Websites      │    │   Table HTML    │    │   (BeautifulSoup)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Cache         │───▶│   Return        │───▶│   Web Chain     │
│   Results       │    │   HTML Data     │    │   Processing    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### LLM Processing Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Input Data    │───▶│   Groq API      │───▶│   LLM Response  │
│   (Context)     │    │   Call          │    │   (JSON)        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Strip Think   │───▶│   Extract JSON  │───▶│   Validate      │
│   Tags          │    │   (Regex)       │    │   Format        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Parse         │───▶│   Check for     │───▶│   Store or      │
│   Result        │    │   Errors        │    │   Queue for     │
│   (JSON)        │    │   (Rate Limit)  │    │   Fallback      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Vector Store Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Initialize    │───▶│   Create        │───▶│   Add           │
│   Embeddings    │    │   Chroma Store  │    │   Documents     │
│   (HuggingFace) │    │   (Persistent)  │    │   (Batch)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Create        │───▶│   Setup         │───▶│   Configure     │
│   Retriever     │    │   Threshold     │    │   Search        │
│   (Chroma)      │    │   (Similarity)  │    │   Parameters    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Enhanced Search Query Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Attribute     │───▶│   Dictionary    │───▶│   Synonyms      │
│   Key           │    │   Values        │    │   (Specific)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Create        │───▶│   Combine       │───▶│   Limit to      │
│   Base Query    │    │   Queries       │    │   20 Unique     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Query Vector  │───▶│   Collect       │───▶│   Limit to      │
│   Store (20x)   │    │   Unique Chunks │    │   10 Chunks     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### Debug & Monitoring Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Function      │───▶│   Debug Logger  │───▶│   Log to File   │
│   Call          │    │   (Class)       │    │   (JSON)        │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Performance   │───▶│   Error         │───▶│   Session       │
│   Tracking      │    │   Handling      │    │   State Log     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Debug         │───▶│   Real-time     │───▶│   Export        │
│   Interface     │    │   Monitoring    │    │   Logs          │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Error Handling Flow
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Error         │───▶│   Check Error   │───▶│   Apply         │
│   Occurs        │    │   Type          │    │   Fallback      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   API Failure   │───▶│   Local Model   │───▶│   Continue      │
│   (Groq)        │    │   Fallback      │    │   Processing    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web Scraping  │───▶│   PDF Only      │───▶│   Stage 2/3     │
│   Failure       │    │   Extraction    │    │   Processing    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   NuMind        │───▶│   PDF           │───▶│   Enhanced      │
│   Failure       │    │   Extraction    │    │   Prompts       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

This visual flowchart shows the complete execution path from application startup through all processing stages, including error handling and fallback mechanisms. 